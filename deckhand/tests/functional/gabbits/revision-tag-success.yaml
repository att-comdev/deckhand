# Tests the following:
#

defaults:
  request_headers:
    content-type: application/x-yaml
  response_headers:
    content-type: application/x-yaml

tests:
  - name: purge
    desc: Begin testing from known state.
    DELETE: /api/v1.0/revisions
    status: 204

    # Create a revision implicitly by creating a document.
  - name: initialize
    desc: Create initial documents
    PUT: /api/v1.0/bucket/mop/documents
    status: 200
    data: <@resources/design-doc-layering-sample.yaml

  - name: create_tag
    desc: Create a tag for the revision
    POST: /api/v1.0/revisions/$RESPONSE['$.[0].status.revision']/tags/foo
    status: 201

    response_multidoc_jsonpaths:
      $[0].data: {}
      $[0].tag: foo

  - name: show_tag
    desc: Verify showing created tag works
    GET: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags/foo
    status: 200

    response_multidoc_jsonpaths:
      $[0].data: {}
      $[0].tag: foo

  - name: create_tag_with_data
    desc: Create a tag with data for the revision
    POST: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags/bar
    status: 201
    data: <@resources/sample-tag-data.yaml

    response_multidoc_jsonpaths:
      $[0].tag: bar
      $[0].data.last: good
      $[0].data.random: data

  - name: list_tags
    desc: Verify listing tags contains created tag
    GET: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags
    status: 200

    response_multidoc_jsonpaths:
      $.[0].tag: bar
      $.[0].data.last: good
      $.[0].data.random: data
      $.[1].tag: foo
      $.[1].data: {}

  - name: delete_tag
    desc: Verify deleting tag works
    DELETE: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags/foo
    status: 204

  - name: verify_tag_delete
    desc: Verify listing tags contains non-deleted tag
    GET: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags
    status: 200

    response_multidoc_jsonpaths:
      $.[0].tag: bar
      $.[0].data.last: good
      $.[0].data.random: data

  - name: delete_all_tags
    desc: Verify deleting tag works
    DELETE: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags
    status: 204

  - name: verify_tag_delete_all
    desc: Verify all tags have been deleted
    GET: /api/v1.0/revisions/$HISTORY['initialize'].$RESPONSE['$.[0].status.revision']/tags
    status: 200

    response_multidoc_jsonpaths:
      $: null
